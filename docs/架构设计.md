# MCore.js 框架架构设计文档

## 1. 设计理念

MCore.js是一个轻量级的微服务基础框架，旨在为Node.js微服务开发提供标准化、可扩展的基础设施。设计理念包括：

### 1.1 模块化设计
框架采用模块化设计，将各功能领域分离成独立的模块，开发者可以按需加载和使用。

### 1.2 可扩展性
框架提供核心功能，同时允许通过插件机制进行扩展，支持自定义组件和中间件。

### 1.3 标准化
提供统一的接口规范和最佳实践，减少各服务间的实现差异，简化开发和维护。

### 1.4 弹性与韧性
内置多种弹性机制（限流、熔断、重试、超时等），提高系统的稳定性和可靠性。

### 1.5 可观测性
集成日志、监控、指标收集和健康检查功能，提高系统的可观测性。

## 2. 系统架构

MCore.js采用分层架构设计，主要包括以下层次：

### 2.1 核心层
提供框架的基础功能，包括应用生命周期管理、配置加载、异常处理等。

### 2.2 通用服务层
提供跨功能模块的通用服务，如日志记录、钩子系统、错误处理等。

### 2.3 功能模块层
提供具体业务功能的模块，如认证授权、数据访问、消息队列等。

### 2.4 适配层
为不同的外部系统和框架提供适配器，如数据库适配器、消息队列适配器等。

### 2.5 扩展层
允许通过插件机制扩展框架功能，支持自定义组件和中间件。

## 3. 模块说明

### 3.1 app模块

应用框架核心，提供微服务的基础架构。

**主要组件：**
- `BaseApp`: 应用基类，管理应用生命周期
- 中间件加载与路由管理
- 优雅启动与关闭
- 健康检查路由

**关键特性：**
- 统一的应用配置
- 应用生命周期钩子
- HTTP服务器管理
- 异常捕获与处理

### 3.2 router模块

路由管理，支持公共路由和受保护路由。

**主要组件：**
- 路由注册与管理
- 路由参数验证
- 路由中间件链
- 控制器绑定

**关键特性：**
- 约定式路由
- 路由分组
- 中间件链支持
- 参数验证

### 3.3 auth模块

身份认证与鉴权模块。

**主要组件：**
- JWT认证
- Session认证
- OAuth集成
- 权限管理

**关键特性：**
- 多认证策略支持
- 令牌管理
- 会话管理
- 权限检查

### 3.4 api模块

API标准模块，提供统一的响应格式和错误处理。

**主要组件：**
- 响应生成器
- 错误处理器
- 参数验证

**关键特性：**
- 统一的响应格式
- 标准化的错误码
- 国际化支持
- 响应数据转换

### 3.5 db模块

数据库访问模块，支持多种数据库和ORM。

**主要组件：**
- 数据库连接管理
- 模型加载
- 查询构建器
- 事务管理

**关键特性：**
- 多数据库支持
- 连接池管理
- 自动模型加载
- 查询优化

### 3.6 registry模块

服务注册与发现模块。

**主要组件：**
- 服务注册器
- 服务发现器
- 健康检查集成

**关键特性：**
- Consul集成
- 自动服务注册
- 服务发现缓存
- 健康状态管理

### 3.7 logging模块

日志管理模块。

**主要组件：**
- 日志工厂
- 日志转换器
- 日志传输器

**关键特性：**
- 多级别日志
- 日志格式化
- 文件滚动
- 结构化日志

### 3.8 audit模块

审计日志模块，记录关键业务操作。

**主要组件：**
- 审计日志记录器
- 审计事件定义
- 审计数据存储

**关键特性：**
- 标准化审计事件
- 多存储支持
- 审计查询
- 合规支持

### 3.9 cache模块

缓存管理模块，支持内存缓存和分布式缓存。

**主要组件：**
- 缓存管理器
- 内存缓存
- Redis缓存

**关键特性：**
- 多级缓存
- 自动过期
- 缓存模式（读写、只读等）
- 缓存失效策略

### 3.10 mq模块

消息队列集成模块，支持多种消息中间件。

**主要组件：**
- 消息客户端
- 消息发布者
- 消息订阅者
- 消息序列化

**关键特性：**
- RabbitMQ支持
- Kafka支持
- 消息重试
- 死信队列

### 3.11 resilience模块

弹性模块，提供服务韧性支持。

**主要组件：**
- 限流器(RateLimiter)
- 熔断器(CircuitBreaker)
- 隔板模式(Bulkhead)
- 重试策略(Retry)
- 超时控制(Timeout)
- 降级策略(Fallback)

**关键特性：**
- 分布式限流
- 自适应熔断
- 可配置重试策略
- 超时管理

### 3.12 config模块

配置中心模块，支持多种配置源。

**主要组件：**
- 配置管理器
- 文件配置源
- 环境变量配置源
- 远程配置源

**关键特性：**
- 分层配置
- 配置热加载
- 环境隔离
- 敏感信息保护

### 3.13 monitor模块

监控与指标收集模块。

**主要组件：**
- 健康检查器
- 指标收集器
- 性能监控
- 资源监控

**关键特性：**
- 自定义健康检查
- Prometheus指标导出
- HTTP请求统计
- 资源使用监控

### 3.14 security模块

安全模块，提供各种安全功能。

**主要组件：**
- 加密工具
- 哈希计算
- 密码处理
- CSRF防护
- XSS防护
- 速率限制
- HTTP安全头
- 授权控制

**关键特性：**
- 标准加密算法
- 密码安全策略
- 内容安全策略
- 访问控制列表

### 3.15 hooks模块

钩子系统，支持应用和业务流程的扩展点。

**主要组件：**
- 钩子管理器
- 钩子上下文
- 钩子执行器

**关键特性：**
- 异步钩子支持
- 钩子执行顺序控制
- 钩子中断机制
- 上下文传递

### 3.16 middlewares模块

中间件集合，提供各种通用中间件。

**主要组件：**
- 响应处理中间件
- 错误处理中间件
- 请求ID中间件
- HTTP日志中间件

**关键特性：**
- Koa中间件支持
- Express中间件支持
- 中间件链组合
- 上下文传递

### 3.17 utils模块

工具函数集合。

**主要组件：**
- 日志工具
- 端口工具
- 字符串工具
- 对象处理工具

**关键特性：**
- 通用工具函数
- 类型转换
- 深度克隆
- 对象合并

## 4. 模块依赖关系

模块间的主要依赖关系如下：

- `app`模块依赖于`logging`、`hooks`、`middlewares`等模块
- `api`模块作为独立模块，被其他模块使用
- `auth`模块依赖于`security`、`db`等模块
- `monitor`模块依赖于`hooks`模块
- `security`模块被多个模块依赖，提供安全功能
- `hooks`模块被大多数模块依赖，提供扩展点
- `utils`模块被所有模块依赖，提供工具函数

## 5. 扩展机制

MCore.js提供多种扩展机制：

### 5.1 钩子系统
通过钩子系统，可以在应用生命周期和业务流程的关键点注入自定义逻辑。

### 5.2 中间件机制
支持添加自定义中间件，扩展HTTP请求处理流程。

### 5.3 适配器模式
各功能模块采用适配器模式，可以自定义实现特定的适配器。

### 5.4 事件系统
提供事件发布/订阅机制，实现模块间的松耦合通信。

## 6. 最佳实践

### 6.1 应用结构
推荐的微服务应用结构：
```
/src
  /config     # 配置文件
  /controllers # 控制器
  /models     # 数据模型
  /services   # 业务服务
  /middlewares # 中间件
  /routes     # 路由定义
  /utils      # 工具函数
  app.js      # 应用入口
```

### 6.2 错误处理
统一使用`api`模块提供的错误处理机制，确保一致的错误响应格式。

### 6.3 认证授权
区分认证和授权逻辑，使用`auth`模块提供的标准机制。

### 6.4 配置管理
使用`config`模块管理配置，避免硬编码配置项。

### 6.5 日志记录
使用`logging`模块记录日志，合理设置日志级别和格式。

### 6.6 弹性设计
对外部依赖操作应用`resilience`模块的弹性机制，提高服务稳定性。

## 7. 总结

MCore.js框架通过模块化设计和标准化接口，为微服务开发提供了一站式解决方案。框架的各个模块互相协作，同时保持松耦合，使开发者能够灵活地选择和组合所需的功能。

通过使用MCore.js，开发团队可以专注于业务逻辑开发，减少基础设施代码的编写，提高开发效率和代码质量。 